#!/usr/bin/perl

use strict;
use warnings;

use FindBin qw( $Bin );
use File::Temp ();
use Text::Template;

my $file = "$Bin/../conf/bridge/iptables.txt";

my $template = Text::Template->new( TYPE => 'FILE', SOURCE => $file );

my $net = `/sbin/ifconfig`;

my ($br0_ip) = $net =~ m/br0(?:.*?)\n(?:\s+)inet[ ]addr\:([^\s]+)/xmsi;

#print "BR is $br0_ip";

my $text = $template->fill_in( HASH => { ip => $br0_ip } ); 

#print "\nText is \n$text";

my $fh = File::Temp->new();
print $fh $text;

my $filename = $fh->filename;

my $foo = `/bin/echo 1 > /proc/sys/net/ipv4/ip_forward`;

my $firewall = `iptables-restore < $filename `;

#print "firewall is $firewall";

