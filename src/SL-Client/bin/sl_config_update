#!/bin/env perl
use strict;
use warnings;

=head1 NAME

sl_config_update - downloads the latest configuration files for the client

=head1 SYNOPSIS

Run this script from cron, frequently:

  * */6 * * * sl_config_update

=head1 DESCRIPTION

This script downloads a set of configuration files for the client proxy,
and updates a shared process cache with the contents of those configuration
files.  By default, the configuration files are downloaded to /tmp, and then
put into place in /usr/local/sl/conf.

=cut

use Cache::FastMmap;
use LWP::UserAgent;

our $DEBUG = 1;
our $CONFIG_URL = "http://www.redhotpenguin.com/sl/conf/";
our $CONFIG_ROOT = '/usr/local/sl/conf/';

# load the cache-file used by the trans-handler
my $class = 'SL::Client::Apache2::TransHandler';
my ($sharefile) = $class =~ s/\:\:/_/g;
my $cache = Cache::FastMmap->new(sharefile => "/tmp/$sharefile");

# grab the files from our static server
my $ua = LWP::UserAgent->new;

foreach my $config_file qw( ext_blacklist proxy_list 
                            ua_blacklist url_blacklist ) {
    
    my $uri = $CONFIG_URL . $config_file . '.txt';
    
    print STDERR "Grabbing file $uri...\n" if $DEBUG;
    my $response = $ua->get($uri);
    if ($response->code == 304) {
        print STDERR "Got 304 response, skip to next file.\n" if $DEBUG;
        next;
    } elsif ($response->code == 200) {
        print STDERR "Got 200 response, grabbing file.\n" if $DEBUG;
        my $fh;
        open($fh, ">", $CONFIG_ROOT . $config_file . '.txt') or die $!;
        print $fh $response->content;
        close($fh);

        # update the cache
        $cache->set($config_file => $response->content);
    } else {
        print STDERR "Got " . $response->code . " response, error.\n";
    }
}

