#!/usr/bin/env perl

use strict;
use warnings FATAL => 'all';

use Template;
use Template::Context;

use SL::Config;

my $server = 'proxy';
my $config = SL::Config->new();

$|++;
if ($ENV{SL_TIMING}) {
    print "Starting in TIMING mode\n";
    $config->sl_proxy_apache_loglevel('info');
}
if ($ENV{SL_DEBUG}) {
    print "Starting in DEBUG mode\n";
    $config->sl_proxy_apache_loglevel('debug');
}

# FIll out the httpd.conf
my $httpd_conf = "httpd_$server.conf";
my $conf_tmpl   = sprintf("%s/$httpd_conf.tmpl", $config->conf_dir);
my $tmpl_out    = sprintf("%s/$httpd_conf", $config->conf_dir);
my %tmpl_config = (ABSOLUTE => 1, INCLUDE_PATH => $config->conf_dir . '/');
my $template    = Template->new(\%tmpl_config) || die $Template::ERROR, "\n";
$template->process($conf_tmpl, { cfg => $config }, $tmpl_out)
  || die $template->error, "\n";

$|++;
my $cmd = sprintf("%s/bin/httpd", $config->sl_root);

$cmd .= " -DONE_PROCESS -DNO_DETACH " if ( $config->sl_debug);

$cmd .= sprintf(" -f %s/$httpd_conf -k start", $config->conf_dir);
print "Starting with command: $cmd\n";
my $started = `$cmd`;
print $started;

1;
