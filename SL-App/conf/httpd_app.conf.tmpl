ServerRoot           [% cfg.sl_httpd_root %]
ServerAdmin          fred@redhotpenguin.com
ServerSignature      Off
ServerTokens         Prod
PidFile              [% cfg.sl_app_root %]/tmp/sl_app.pid
DocumentRoot         [% cfg.sl_app_root %]/htdocs
TypesConfig          [% cfg.sl_app_root %]/conf/mime.types
User                 [% cfg.sl_app_apache_user %] 
Group                [% cfg.sl_app_apache_group %]
KeepAlive            [% cfg.sl_app_apache_keepalive %]
MaxKeepAliveRequests 0
KeepAliveTimeout     300
MinSpareServers      [% cfg.sl_app_apache_min_spare_servers %]
MaxSpareServers      [% cfg.sl_app_apache_max_spare_servers %]
StartServers         [% cfg.sl_app_apache_start_servers %]
LogLevel             [% cfg.sl_app_apache_loglevel %]
MaxClients           [% cfg.sl_app_apache_maxclients %]
ErrorLog             [% cfg.sl_app_root %]/logs/httpd_app_error_log
TransferLog          [% cfg.sl_app_root %]/logs/httpd_app_access_log
MaxRequestsPerChild  250
LogFormat "%h %l %u %t (%{User-agent}i) \"%r\" %>s %b"
UseCanonicalName     Off
HostNameLookups      Off
Timeout              300

Listen        [% cfg.sl_app_http_port %]

ServerName           [% cfg.sl_app_servername %]
ErrorDocument        404	/404.html
ErrorDocument        500	/500.html

LoadModule apreq_module        modules/mod_apreq2.so
LoadModule perl_module        modules/mod_perl.so

PerlPassEnv SL_DEBUG

PerlPostConfigRequire "[% cfg.sl_app_root %]/conf/startup_app.pl"

[% IF cfg.sl_debug %]
PerlRequire "[% cfg.sl_app_root %]/conf/db.pl"
[% END %]
PerlSetVar data_root "[% cfg.sl_app_root %]/data"

# Apache::Reload for quick fixes
PerlModule           Apache2::Reload
PerlInitHandler      Apache2::Reload
PerlSetVar           ReloadAll On
PerlSetVar ReloadModules "SL::* Apache2::* ModPerl::*"

[% IF cfg.sl_prof %]
	PerlModule Apache::DProf
[% END %]

PerlPostReadRequestHandler Apache2::Const::OK

# turning these on screws up the css serving
#PerlMapToStorageHandler    Apache2::Const::OK
#PerlTransHandler		   Apache2::Const::OK

PerlLoadModule Apache2::Dispatch

## the public facing page
## FIXME - apache dispatch bug
<Location />
	SetHandler modperl

    # dispatch directives
	DispatchPrefix SL::Apache::App
	[% IF dispatch_debug %]DispatchDebug [% dispatchdebug %][% END %]
	DispatchRequire On
	DispatchUpperCase On

	PerlResponseHandler Apache2::Dispatch
</Location>

<Location /css>
    SetHandler default-handler
</Location>

<Location /img>
    SetHandler default-handler
</Location>


## the user application, need to be logged in
<Location  /app>
	AuthType SL::Apache::App::CookieAuth
	AuthName [% cfg.sl_app_cookie_name %]
	SetHandler modperl
	PerlAuthenHandler SL::Apache::App::CookieAuth->authenticate
	PerlAuthzHandler Apache2::Const::OK
	require valid-use
</Location>

<Location /login>
	SetHandler modperl
	PerlResponseHandler SL::Apache::App::CookieAuth->login
</Location>

<Location /logout>
	SetHandler modperl
	PerlResponseHandler SL::Apache::App::CookieAuth->logout
</Location>

<Location /forgot>
	SetHandler modperl
	PerlResponseHandler SL::Apache::App::CookieAuth->forgot
</Location>

<Location /signup>
	SetHandler modperl
	PerlResponseHandler SL::Apache::App::CookieAuth->signup
</Location>

<Location /forgot/reset>
    SetHandler modperl
    PerlResponseHandler SL::Apache::App::CookieAuth->forgot_reset
</Location>

## registration
<Location /reg>
	SetHandler modperl
	PerlResponseHandler SL::Apache::App::reg
</Location>

## handle click requests
<Location /click>
    SetHandler          modperl
 	PerlHeaderParserHandler Apache2::Const::OK
    PerlAccessHandler       Apache2::Const::OK
    PerlAuthenHandler       Apache2::Const::OK
    PerlAuthzHandler        Apache2::Const::OK
    PerlTypeHandler         Apache2::Const::OK
[% IF cfg.sl_debug %]
    PerlFixupHandler +Apache::DB
[% ELSE %]
    PerlFixupHandler        Apache2::Const::OK
[% END %]
    PerlResponseHandler     SL::Apache::App::Click
</Location>

<Directory />
    AllowOverride None
</Directory>
[% IF cfg.sl_proxy_deflate %]
Include [% cfg.sl_app_root %]/conf/deflate.conf
[% END %]
